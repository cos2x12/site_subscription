<?php

use Drupal\Core\Database\Database;

<<<<<<< HEAD
/**
 * Implements hook_cron().
 */
function site_subscription_cron() {
    $connection = \Drupal::database();
    $config = \Drupal::config('site_subscription.settings');
=======

//функция отправки по крону
function site_subscription_cron() {
    $connection = \Drupal::database();
    $config = \Drupal::config('site_subscription.settings');
    $value_settings = $config->get('number');

    $last_count = \Drupal::state()->get('count');
    if(!$last_count){
        $last_count = 0;
        }   
/**
 * Implements hook_cron().
 */
function site_subscription_cron() {
    $connection = \Drupal::database();
    $config = \Drupal::config('site_subscription.settings');
>>>>>>> 5b68e21ef18f6704fd0901ba83d8a4563dcdbe1a
    $number = $config->get('number');
    
    // Считывает значение из системной конфигурации.
    $site_subscription_count = \Drupal::state()->get('site_subscription_count');
    if (!$site_subscription_count) {
        $site_subscription_count = 0;
    }

<<<<<<< HEAD
=======

>>>>>>> 5b68e21ef18f6704fd0901ba83d8a4563dcdbe1a
    $query = $connection->select('site_subscription', 'n');
    $query->fields('n');
    $query->range($site_subscription_count, $number);
    $result = $query->execute();

<<<<<<< HEAD
=======
    $last_count = $last_count + (int) $value_settings;
    $limit = \Drupal::state()->set('count', $last_count); 
    
    foreach ($result as $row) {
        $limit++;       


>>>>>>> 5b68e21ef18f6704fd0901ba83d8a4563dcdbe1a
    foreach ($result as $row) {       
        $mail = $row->mail;
        \Drupal::logger('site_subscription')->notice($mail);
    }

    // Сохраняет значение в системную конфигурацию.
    $site_subscription_count = $site_subscription_count + $number;
    \Drupal::state()->set('site_subscription_count', $site_subscription_count);       
}